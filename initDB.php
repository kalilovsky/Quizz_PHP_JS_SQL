<?php
$themesTxt = "Animés-/Animés-/Animés-/Animés-/Animés-/Animés-/Gaming-/Gaming-/Gaming-/Gaming-/Gaming-/Gaming-/Gaming-/Gaming-/Gaming-/Gaming-/Cinéma-/Cinéma-/Cinéma-/Cinéma-/Cinéma-/Cinéma-/Cinéma-/Cinéma-/Cinéma-/Cinéma-/Technologie-/Technologie-/Technologie-/Technologie-/Technologie-/Technologie-/Technologie-/Technologie-/Technologie-/Technologie";
$q1Txt = "Où est-ce que Kaneki décide de travailler ?-/Comment s’appelle l’auteur que Kaneki aime beaucoup ?-/Dans quel manga ou anime, le héros est un petit robot ?-/Qui est l’étudiant  qui dépasse certain héro pro ?-/Qui emmène Eren au tribunal ?-/Lors du combat final contre Buu buu , Vegeta déclare que ?-/Quelle est l'année de sortie de la Super Nintendo en France ? -/Dans quelle ville est né Altaïr, le héros du premier Assassin's Creed ?-/Comment s’appel le puissant héro de God of war ?-/De quels jeux Franklin Michael Trevor sont-ils  issus ?-/Quel studio a développé Call of Duty: Advanced Warfare ?-/Quel est le nom du créateur de Mario ?-/Quel moteur graphique utilisé dans les jeux battlefield ?-/Dans the last of us comment appelle t’on le champignon responsable de l’infection ?-/Dans Apex Legend comment se nomme le héros possédant un corbeau ?-/Quel est le studio qui a crée la licence Assassin’s Creed ?-/De quel film est issu la musique culte « Now we are free »?-/Dans le film « La Chute du Faucon noir » quel est la force d’intervention à pied ?-/Dans le film gladiator qui assassine Marc Aurèle ? -/En quel lieu Frodon se fait-il blesser par l'un des neuf cavaliers noirs ?-/A travers quel artefact possédé par Saroumane voit-on luire l'oeil de Sauron ?-/Dans intouchable, qu’elle est l’handicape de Phillipe ?-/Dans The Amazing Spiderman quel est la vraie identité d’électro ?-/Dans X men origins Wolwerine Logan se prend une explosion de quel type ?-/Comment s’ appel le méchant qui a copié la technologie Stark lors du grand prix à Monaco ?-/Dans Transformers comment appelle t’on l’élément pouvant réanimer un transformers ?-/Que veut dire High tech ?-/Que veut dire RAM ?-/Quel est le role d’un processeur ?-/Où se trouve le siège d’Intel Corporation ?-/Que veut dire CPL ?-/Quel est le le classement juste  des stockages les plus rapides ?-/Quel type de connexion est la plus rapide ?-/Quel débit est le plus rapide ?-/Quel est le nouveau nom de Facebook?-/Qui est le successeur de Steve Jobs ?";
$q2Txt = "Dans un bar.-/Takatsuki Sen-/Yume Senshi-/Lemillion-/Erwin Smith-/Goku est un imbécile-/1990-/Jérusalemen-/Credos-/Red dead rédemption 2-/Treyarch studio-/Akira Toriyama-/Unity-/Cordyceps-/Wraith-/Valve-/Gladiator-/Mac V SOG-/Spartacus-/Amon sûl-/Le miroir Galadriel-/Il est paraplégique-/Arthur Parks-/Incident industrielle-/Enton Vanko-/La Matrice de commandement-/Technologie-/Random Access Memory-/D’exécuter des fréquences d’images-/Santa Monica-/Courant porteur de liens-/HDD<SSD<SD<Flash Memory-/VDSL2-/Tera bits/s-/Méta-/Ragnar Lothbrok";
$q3Txt = "Dans un café appelé l’Antique.-/Tachibana Sen-/Wingman-/Endevor-/Levy-/Goku est le numéro 1-/1991-/Rome-/Démios-/The last of us-/Sledge Hammer Games-/Shigeru Miyamoto-/Unreal Engine-/Coprin-/Sombra-/Bethesda-/Star Wars-/Les Marines-/Octave-/Le mont Ventoux-/Le bâton de pouvoir-/Il est tétraplégique-/Steeve Rogers-/Une explosion-/Ivan Vanko-/Le All Spark-/La petite technologie-/Right Acces Mobile-/D’échanger des données entre les différents composants informatique-/Santa Clara-/Couverture pérméable de ligne-/Flash Memory <SD< HDD<SSD-/Modem-/Gigabyte /s-/Messenger-/Mark Zuckerberg";
$q4Txt = "Dans un restaurant pour Goule. -/Takatsuki Seido-/Astro Boy-/Hawks-/Hanzi Zoé-/Goku est le plus gentil des sayans-/1992-/Masyaf-/Kratos-/Grand Theft Auto 5-/Rockstar Games-/Zang Yamoto-/Rage-/Amanite Phalloïde-/Bloodhound-/Criterion-/Le seigneur des Anneaux-/La Delta Force-/Comode-/Le Gué de Bruinen-/Le Palantir-/Il est hémiplégique-/Max Dillon-/Une Explosion atomique-/Jin Khanè-/Le cube de commandement-/La haute technologie-/Rainbow Acces Memory-/De stocker des données-/Santa Barbara-/Courant porteur en ligne-/SD<SSD<Flash Memory<HDD-/ADSL-/Mégabyte/s-/Discord-/Richard Branson";
$q5Txt = "À l’université.-/Akira Mado-/Gundam Wing-/Stain-/Mikasa Ackerman-/Goku est son plus grand rival-/1993-/Sparte-/Sakrot-/Grand theft Auto 4-/Infinity Ward-/Dashan Wang-/Frostbite-/Lactarius Amirus-/Mirage-/Ubisoft-/Il faut sauver le soldat Rayan-/Les Spetsnaz-/Maximus-/Le mont Valérien-/Le Tesseract-/Il est polyphylétique-/Curtis Connors-/Un tir de mortier-/Raymon Barkov-/Le tesseract commandement-/La techno-/Random Admin Memory-/De centraliser la prise en charge de la RAM-/Santa Clause-/Courant paramétrable de ligne-/SSD<HDD<Flash Memory<SD-/Fibre-/Microbytes /s-/Zétaverse-/Tim Cook";
$repTxt = "2-/1-/3-/4-/2-/2-/2-/3-/3-/3-/2-/2-/4-/1-/3-/4-/1-/3-/3-/1-/3-/2-/3-/3-/2-/1-/3-/1-/2-/2-/3-/2-/4-/1-/1-/4";

$themesSplit = explode('-/', $themesTxt);
$q1Split = explode('-/', $q1Txt);
$r1Split = explode('-/', $q2Txt);
$r2Split = explode('-/', $q3Txt);
$r3Split = explode('-/', $q4Txt);
$r4Split = explode('-/', $q5Txt);
$answerSplit = explode('-/', $repTxt);

for ($i = 0; $i < count($themesSplit); $i++) {
    $tableauDesQst[$i]['themes'] = $themesSplit[$i];
    $tableauDesQst[$i]['q1'] = $q1Split[$i];
    $tableauDesQst[$i]['r1'] = $r1Split[$i];
    $tableauDesQst[$i]['r2'] = $r2Split[$i];
    $tableauDesQst[$i]['r3'] = $r3Split[$i];
    $tableauDesQst[$i]['r4'] = $r4Split[$i];
    $tableauDesQst[$i]['answer'] = $tableauDesQst[$i]['r' . $answerSplit[$i]];
}

try {
    $db = new PDO('mysql:host=localhost;dbname=QUIZZ;charset=utf8', 'root', 'root');
} catch (Exception $e) {
    die('Erreur : ' . $e->getMessage());
}
//Vérification que les tables existes et qu'il y a des enregistrement
//Via la table Themes, on verifie qu'il n'y a pas d'erreurs dans le PDO
// Ensuite on verifie qu'il y a des enregistrements
//Si il y a une erreur on affiche l'erreur et on arrete le programme
//si il n'y pas d'enregistrement on lance l'initialisation des enregistrements
//tous ça grace à cette fonction
function verifErreurs ($dataBase){
    $sqlQuery = "SELECT id_themes FROM THEMES";
    $sqlPrepare = $dataBase->prepare($sqlQuery);
    $sqlPrepare->execute();
    
    $errorReport = $sqlPrepare->errorInfo();
    $verifData = $sqlPrepare->fetchAll();
    $verifData = count($verifData);
    
    if ($errorReport[2]!= null){
        return 'erreur';
    } 
    if ($verifData ==0){
        
        return 'allOk';
    }else {
        return 'dataExists';
    }
}
//Faire un switch pour éxécuter des instructions selon la valeur retournée
//de la fonction verifErreur()
$bddState = verifErreurs($db);
switch ($bddState){
    case 'allOk':
        //préparation de la commande sql pour l'écriture des données themes
        $sqlQuery = 'INSERT INTO THEMES(themes_txt) VALUES (:themes_txt)';
        //mets l'unicité des themes dans la variable $themeUnique
        //Pour préparer la premiere écriture dans la base de donneés
        $themesUnique = array_unique ($themesSplit);
        //préparation de la requetes sql
        $insertRecipe = $db->prepare($sqlQuery);
        //ecriture de la données 
        foreach($themesUnique as $sqlThemes){
            $insertRecipe->execute([
                    'themes_txt'=>$sqlThemes
                ]);
        }


        //ecriture des questions dans la base de données
        $sqlQuery = 'INSERT INTO QUESTIONS(qst_txt,good_answer,id_themes,score_qst) VALUES (:qst_txt1,:good_ans,:id_theme,2)';

        //préparation de l'enregistrement
        $insertData = $db->prepare($sqlQuery);
        foreach($tableauDesQst as $tableau){
            //Réxupération de l'id du themes liés à la question pour l'enregistrer dans l'id de la table questions
            $sqlQuery2 = 'SELECT id_themes FROM THEMES WHERE themes_txt = :valeurThemes';
            $sqlRequest2= $db->prepare($sqlQuery2);
            $sqlRequest2->execute([
                'valeurThemes'=>$tableau['themes']
            ]);
            //récupere la data et la fetch
            $sqlResult2 =$sqlRequest2->fetch();
            //enregistre les données dans la base de données avec l'id themes correspendant
            $insertData->execute([
                            'qst_txt1'=>$tableau["q1"],
                            'good_ans'=>$tableau["answer"],
                            'id_theme'=>$sqlResult2[0]
                        ]);
                        // echo($tableau["q1"]."<br>");
                        // echo($tableau["answer"]);
                        // $tt=$insertData->errorInfo();
                        // print_r ($insertData->errorCode()."<br>".$tt[2]."<br>");
        }

        //ecriture de la données des 4 réponses en incluant l'id de la question corréspondantes aux réponses
        $sqlQuery = 'INSERT INTO REPONSES(answer_txt,id_qst) VALUES (:ans_txt,:id_qt)';
        $insertData = $db->prepare($sqlQuery);
        foreach($tableauDesQst as $tableau){
            //Réxupération de l'id de la question liés aux réponses
            $sqlQuery3 = 'SELECT id_qst FROM QUESTIONS WHERE qst_txt = :valeurQst';
            $sqlRequest3= $db->prepare($sqlQuery3);
            $sqlRequest3->execute([
                        "valeurQst"=>$tableau["q1"]
            ]);
            $sqlResult3 = $sqlRequest3->fetch();
            //echo(count($sqlResult3));

            $insertData->execute([
                'ans_txt'=>$tableau["r1"],
                'id_qt'=>$sqlResult3[0]
            ]);
            $insertData->execute([
                'ans_txt'=>$tableau["r2"],
                'id_qt'=>$sqlResult3[0]
            ]);
            $insertData->execute([
                'ans_txt'=>$tableau["r3"],
                'id_qt'=>$sqlResult3[0]
            ]);
            $insertData->execute([
                'ans_txt'=>$tableau["r4"],
                'id_qt'=>$sqlResult3[0]
            ]);

        }
        break;
    case "erreur" :
        printf("Erreur, il faut probablement créer les tables ..etc grace au fichier SQL.");
        break;
    case "dataExists":
        // printf("Base de donnée, et enregistrements détéctés.");
        break;
    default:
        
}    
        
